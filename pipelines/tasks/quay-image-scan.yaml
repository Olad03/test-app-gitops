apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: quay-image-scan
spec:
  params:
    - name: IMAGE
      type: string
      description: Full image reference (quay.io/org/repo:tag)
    - name: QUAY_API
      type: string
      default: https://quay.io/api/v1
    - name: FAIL_ON_SEVERITY
      type: string
      default: High
  steps:
    - name: wait-for-scan
      image: registry.access.redhat.com/ubi9/ubi-minimal
      env:
        - name: QUAY_TOKEN
          valueFrom:
            secretKeyRef:
              name: quay-credentials
              key: token
      script: |
        #!/bin/bash
        set -e

        IMAGE="$(params.IMAGE)"
        ORG=$(echo $IMAGE | cut -d/ -f2)
        REPO=$(echo $IMAGE | cut -d/ -f3 | cut -d: -f1)
        TAG=$(echo $IMAGE | cut -d: -f2)

        echo "Waiting for Quay scan: $ORG/$REPO:$TAG"

        for i in {1..30}; do
          STATUS=$(curl -s -H "Authorization: Bearer $QUAY_TOKEN" \
            $(params.QUAY_API)/repository/$ORG/$REPO/tag/$TAG \
            | jq -r '.tags[0].security_status')

          echo "Scan status: $STATUS"

          if [[ "$STATUS" == "scanned" ]]; then
            break
          fi

          sleep 10
        done

        if [[ "$STATUS" != "scanned" ]]; then
          echo "❌ Scan did not complete in time"
          exit 1
        fi

        VULNS=$(curl -s -H "Authorization: Bearer $QUAY_TOKEN" \
          $(params.QUAY_API)/repository/$ORG/$REPO/tag/$TAG/vulnerabilities \
          | jq '.data.Layer.Features[].Vulnerabilities[] | select(.Severity=="High" or .Severity=="Critical")')

        if [[ -n "$VULNS" ]]; then
          echo "❌ High/Critical vulnerabilities found"
          exit 1
        fi

        echo "✅ Quay image scan passed"
